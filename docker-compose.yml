services:
  app:
    build:
      context: .
      dockerfile_inline: |
        FROM node:18-alpine AS deps
        RUN apk add --no-cache libc6-compat
        WORKDIR /app
        COPY package.json package-lock.json ./
        RUN npm ci

        FROM node:18-alpine AS builder
        WORKDIR /app
        COPY --from=deps /app/node_modules ./node_modules
        COPY . .
        ENV NEXT_TELEMETRY_DISABLED=1
        # Set build-time environment variables (use defaults if not provided)
        ARG MONGODB_URI
        ARG INVOICE_GENERATOR_API_KEY
        ARG COMPANY_NAME
        ARG COMPANY_LOGO_URL
        ARG COMPANY_EMAIL
        ARG COMPANY_CITY
        ARG COMPANY_COUNTRY
        ARG COMPANY_VAT_ID
        ENV MONGODB_URI=${MONGODB_URI:-mongodb://mongo:27017/invoice-generator}
        ENV INVOICE_GENERATOR_API_KEY=${INVOICE_GENERATOR_API_KEY}
        ENV COMPANY_NAME=${COMPANY_NAME:-Technioz}
        ENV COMPANY_TAGLINE=${COMPANY_TAGLINE:-Innovative Solutions Seamless Integration}
        ENV COMPANY_LOGO_URL=${COMPANY_LOGO_URL:-logo.png}
        ENV COMPANY_PHONE=${COMPANY_PHONE:-"+91 9803683577"}
        ENV COMPANY_EMAIL=${COMPANY_EMAIL:-info@technioz.com}
        ENV COMPANY_ADDRESS=${COMPANY_ADDRESS:-"Jalandhar, Punjab"}
        ENV COMPANY_CITY=${COMPANY_CITY:-Jalandhar}
        ENV COMPANY_COUNTRY=${COMPANY_COUNTRY:-India}
        ENV COMPANY_VAT_ID=${COMPANY_VAT_ID:-}
        RUN npm run build

        FROM node:18-alpine
        WORKDIR /app
        ENV NODE_ENV=production
        ENV NEXT_TELEMETRY_DISABLED=1
        RUN addgroup --system --gid 1001 nodejs
        RUN adduser --system --uid 1001 nextjs
        COPY --from=builder /app/public ./public
        RUN mkdir -p /app/public/invoices && chown -R nextjs:nodejs /app/public/invoices
        COPY --from=builder --chown=nextjs:nodejs /app/.next/standalone ./
        COPY --from=builder --chown=nextjs:nodejs /app/.next/static ./.next/static
        USER nextjs
        EXPOSE 3000
        ENV PORT=3000
        ENV HOSTNAME="0.0.0.0"
        CMD ["node", "server.js"]
    ports:
      - "${PORT:-3000}:3000"
    environment:
      - MONGODB_URI=${MONGODB_URI}
      - INVOICE_GENERATOR_API_KEY=${INVOICE_GENERATOR_API_KEY}
      - NODE_ENV=production
      - COMPANY_LOGO_URL=${COMPANY_LOGO_URL}
      - PORT=${PORT:-3000}
      # Optional: Company details (with defaults from config.js)
      - COMPANY_NAME=${COMPANY_NAME:-Technioz}
      - COMPANY_EMAIL=${COMPANY_EMAIL:-info@technioz.com}
      - COMPANY_CITY=${COMPANY_CITY:-Jalandhar}
      - COMPANY_COUNTRY=${COMPANY_COUNTRY:-India}
      - COMPANY_VAT_ID=${COMPANY_VAT_ID:-}
    depends_on:
      mongo:
        condition: service_healthy
    volumes:
      - invoices_data:/app/public/invoices
    restart: unless-stopped

  mongo:
    image: mongo:7
    volumes:
      - mongo_data:/data/db
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh --quiet
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped

volumes:
  mongo_data:
  invoices_data:
