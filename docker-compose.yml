services:
  app:
    build:
      context: .
      dockerfile_inline: |
        FROM node:18-alpine AS deps
        RUN apk add --no-cache libc6-compat
        WORKDIR /app
        COPY package.json package-lock.json ./
        RUN npm ci

        FROM node:18-alpine AS builder
        WORKDIR /app
        COPY --from=deps /app/node_modules ./node_modules
        COPY . .
        ENV NEXT_TELEMETRY_DISABLED=1
        # Set build-time environment variables (use defaults if not provided)
        ARG MONGODB_URI
        ARG INVOICE_GENERATOR_API_KEY
        ARG AUTH_SESSION_SECRET
        ARG AUTH_PIN_SALT
        ARG AUTH_PIN_HASH
        ARG AUTH_WEBAUTHN_RP_ID
        ARG AUTH_WEBAUTHN_ORIGIN
        ARG AUTH_WEBAUTHN_RP_NAME
        ARG AUTH_DEBUG
        ARG RECURRING_CRON_SECRET
        ENV MONGODB_URI=${MONGODB_URI:-mongodb://mongo:27017/invoice-generator}
        ENV INVOICE_GENERATOR_API_KEY=${INVOICE_GENERATOR_API_KEY}
        ENV AUTH_SESSION_SECRET=${AUTH_SESSION_SECRET}
        ENV AUTH_PIN_SALT=${AUTH_PIN_SALT}
        ENV AUTH_PIN_HASH=${AUTH_PIN_HASH}
        ENV AUTH_WEBAUTHN_RP_ID=${AUTH_WEBAUTHN_RP_ID}
        ENV AUTH_WEBAUTHN_ORIGIN=${AUTH_WEBAUTHN_ORIGIN}
        ENV AUTH_WEBAUTHN_RP_NAME=${AUTH_WEBAUTHN_RP_NAME:-Biller}
        ENV AUTH_DEBUG=${AUTH_DEBUG:-false}
        ENV RECURRING_CRON_SECRET=${RECURRING_CRON_SECRET}
        RUN npm run build

        FROM node:18-alpine
        WORKDIR /app
        ENV NODE_ENV=production
        ENV NEXT_TELEMETRY_DISABLED=1
        RUN addgroup --system --gid 1001 nodejs
        RUN adduser --system --uid 1001 nextjs
        COPY --from=builder /app/public ./public
        RUN mkdir -p /app/public/invoices && chown -R nextjs:nodejs /app/public/invoices
        COPY --from=builder --chown=nextjs:nodejs /app/.next/standalone ./
        COPY --from=builder --chown=nextjs:nodejs /app/.next/static ./.next/static
        USER nextjs
        EXPOSE 3000
        ENV PORT=3000
        ENV HOSTNAME="0.0.0.0"
        CMD ["node", "server.js"]
    expose:
      - "3000"
    environment:
      - MONGODB_URI=${MONGODB_URI}
      - INVOICE_GENERATOR_API_KEY=${INVOICE_GENERATOR_API_KEY}
      - NODE_ENV=production
      - PORT=${PORT:-3000}
      - AUTH_SESSION_SECRET=${AUTH_SESSION_SECRET}
      - AUTH_PIN_SALT=${AUTH_PIN_SALT}
      - AUTH_PIN_HASH=${AUTH_PIN_HASH}
      - AUTH_WEBAUTHN_RP_ID=${AUTH_WEBAUTHN_RP_ID}
      - AUTH_WEBAUTHN_ORIGIN=${AUTH_WEBAUTHN_ORIGIN}
      - AUTH_WEBAUTHN_RP_NAME=${AUTH_WEBAUTHN_RP_NAME:-Biller}
      - AUTH_DEBUG=${AUTH_DEBUG:-false}
      - RECURRING_CRON_SECRET=${RECURRING_CRON_SECRET}
    depends_on:
      mongo:
        condition: service_healthy
    volumes:
      - invoices_data:/app/public/invoices
    restart: unless-stopped

  recurring-cron:
    image: alpine:3.20
    environment:
      - RECURRING_CRON_SECRET=${RECURRING_CRON_SECRET}
      - TZ=${TZ:-UTC}
    depends_on:
      - app
    command: >
      /bin/sh -c "
      apk add --no-cache curl tzdata >/dev/null &&
      echo '0 0 * * * curl -fsS -X POST -H \"x-recurring-cron-secret: '$$RECURRING_CRON_SECRET'\" http://app:3000/api/invoices/recurring/process >/proc/1/fd/1 2>/proc/1/fd/2' > /etc/crontabs/root &&
      crond -f -l 8
      "
    restart: unless-stopped

  mongo:
    image: mongo:7
    volumes:
      - mongo_data:/data/db
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh --quiet
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped

volumes:
  mongo_data:
  invoices_data:
